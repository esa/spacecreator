image: $CI_REGISTRY_IMAGE/taste-buster:latest

stages:
  - build-test
  - build-test-bundle


default:
  before_script:
    - source $CI_PROJECT_DIR/scripts/timestamp.sh
    # dependencies
    - apt install -y  build-essential git g++ cmake cmake-data ninja-build make gcovr lcov ccache cccc doxygen graphviz zip p7zip curl wget default-jre uuid-dev pkg-config fuse python3-pip clang-format spin python3-pygraphviz python3-singledispatch python3-stringtemplate3 python3-pexpect
    # install modified xmldiff
    - pip3 install git+https://github.com/Shoobx/xmldiff
    # install OpenGEODE dependencies
    # *Python (both for OpenGEODE and sdl2promela)
    - pip3 install black==21.10b0 multipledispatch pyside6 pytest py7zr aqtinstall GitPython
    # install newest OpenGEODE 3.x (must be installed in the same directory, removal is more robust than git clean/checkout/force)
    # NOTE: the used version here is not the latest. But the last one before 'offspring' field was added.
    - pushd $HOME/tool-src; rm -r opengeode ; git clone https://gitrepos.estec.esa.int/taste/opengeode.git ; cd opengeode ; git checkout bad808d008c2c3e3e28275528e9fa9512541ed94 ; make install; popd
    # install newest version of Spin model checker
    - pushd $HOME/tool-src; rm -rf Spin ; git clone https://github.com/n7space/Spin.git ; cd Spin ; make; popd ; mv $HOME/tool-src/Spin/Src/spin $HOME/.local/bin/n7s-spin
    # install sdl2promela
    - git clone https://github.com/n7space/sdl2promela.git
    - pushd sdl2promela ; make install ; popd
    # setup PATH
    - export PATH=$PATH:$ENV_DIR/asn1scc
    - export PATH=$PATH:/root/.local/bin
    # CCache Config
    - mkdir -p ccache
    - export CCACHE_BASEDIR=$CI_PROJECT_DIR
    - export CCACHE_DIR=$CI_PROJECT_DIR/ccache


spacecreator-master:
  stage: build-test-bundle
  variables:
    PROJECT_DIR: $CI_PROJECT_DIR
    ENV_QT_VERSION: 6.4.1
    ENV_QTC_VERSION: 9.0.0
    ENV_DIR: /opt/spacecreator6
    APP_DIR: $ENV_DIR/spacecreator.AppDir
    ENV_QT_BASE_DIR: $ENV_DIR/Qt/$ENV_QT_VERSION/gcc_64
    BUILD_DIR: $CI_PROJECT_DIR/spacecreator_build_qt6
  script:
    # pre build: create build environment containing Qt with Grantlee, QtCreator with dev files, etc.
    - python3 $CI_PROJECT_DIR/scripts/prebuild.py --output_dir $ENV_DIR --project_dir $PROJECT_DIR --app_dir $APP_DIR --qt_version $ENV_QT_VERSION --qtcreator_version $ENV_QTC_VERSION
    # show initial caching statistics
    - ccache -s
    # build space creator
    - python3 $CI_PROJECT_DIR/scripts/build_spacecreator.py --project_dir $PROJECT_DIR --app_dir $APP_DIR --env_dir $ENV_DIR --build_dir $BUILD_DIR --build_type Release --no_build_asn1plugin --patch_version $CI_BUILD_ID
    # show caching statistics
    - ccache -s
    # post build: Copy the SpaceCreator-plugin to the plugin-directory of the QtCreator that is to load it.
    - python3 $CI_PROJECT_DIR/scripts/postbuild.py --project_dir $PROJECT_DIR --app_dir $APP_DIR --build_dir $BUILD_DIR
    # unit tests
    - ./scripts/run_tests.sh $BUILD_DIR
    # read the version numbers
    - source ./VERSION # set $SC_VERSION. The version of the project is stored the shell script VERSION
    # Create an AppImage from the app_dir and place it in the build dir
    - python3 $CI_PROJECT_DIR/scripts/create_appimage.py --output_dir $BUILD_DIR --project_dir $PROJECT_DIR --app_dir $APP_DIR --env_dir $ENV_DIR --project_version $SC_VERSION
  cache:
    key: spacecreator_cache
    paths:
      - $BUILD_DIR/asn1scc_bin
      - ccache
  artifacts:
    reports:
      junit: $BUILD_DIR/tst_*-result.xml
    paths:
      - "$BUILD_DIR/spacecreator*.AppImage"
    expire_in: 2 days
  rules:
    - if: "$CI_COMMIT_BRANCH == 'master'"


spacecreator-feature:
  stage: build-test
  variables:
    PROJECT_DIR: $CI_PROJECT_DIR
    ENV_QT_VERSION: 6.4.1
    ENV_QTC_VERSION: 9.0.0
    ENV_DIR: /opt/spacecreator6
    APP_DIR: $ENV_DIR/spacecreator.AppDir
    ENV_QT_BASE_DIR: $ENV_DIR/Qt/$ENV_QT_VERSION/gcc_64
    BUILD_DIR: $CI_PROJECT_DIR/spacecreator_build_qt6
  script:
    # pre build: create build environment containing Qt with Grantlee, QtCreator with dev files, etc.
    - python3 $CI_PROJECT_DIR/scripts/prebuild.py --output_dir $ENV_DIR --project_dir $PROJECT_DIR --app_dir $APP_DIR --qt_version $ENV_QT_VERSION --qtcreator_version $ENV_QTC_VERSION
    # show initial caching statistics
    - ccache -s
    # build space creator
    - python3 $CI_PROJECT_DIR/scripts/build_spacecreator.py --project_dir $PROJECT_DIR --app_dir $APP_DIR --env_dir $ENV_DIR --build_dir $BUILD_DIR --build_type Release --no_build_asn1plugin --patch_version $CI_BUILD_ID
    # show caching statistics
    - ccache -s
    # post build: Copy the SpaceCreator-plugin to the plugin-directory of the QtCreator that is to load it.
    - python3 $CI_PROJECT_DIR/scripts/postbuild.py --project_dir $PROJECT_DIR --app_dir $APP_DIR --build_dir $BUILD_DIR
    # read the version numbers
    - source ./VERSION # set $SC_VERSION. The version of the project is stored the shell script VERSION
    # unit tests
    - ./scripts/run_tests.sh $BUILD_DIR
  cache:
    key: spacecreator_cache
    paths:
      - $BUILD_DIR/asn1scc_bin
      - ccache
  artifacts:
    reports:
      junit: $BUILD_DIR/tst_*-result.xml
    expire_in: 2 days
  rules:
    # For pipelines created when a merge request is created or updated
    - if: "$CI_PIPELINE_SOURCE == 'merge_request_event'"
