stages:
  - build-test-and-bundle


space-creator:
  stage: build-test-and-bundle
  image: taste-buster:latest
  script:
    - export PROJECT_ROOT=$(pwd)
    - export ENV_QTC_VERSION_SHORT=4.8
    - export ENV_QTC_VERSION=4.8.2
    - export ENV_QT_VERSION=5.12.1
    - export DOWNLOAD_DIR=/opt/qt-creator-dev
    - export BUILD_DIR=${PROJECT_ROOT}/build
    - export PACKAGE_DIR=${PROJECT_ROOT}/package
    - export CMAKE_BUILD=-DCMAKE_BUILD_TYPE=Release
    - export ENV_QT_BASE_DIR=${DOWNLOAD_DIR}/Qt/${ENV_QT_VERSION}/gcc_64
    - mkdir -p ${DOWNLOAD_DIR}
    - mkdir -p ${BUILD_DIR}
    - mkdir -p ${PACKAGE_DIR}
    # dependencies
    - apt install -y  build-essential git g++ cmake cmake-data ninja-build make qtbase5-dev-tools qtbase5-dev qtdeclarative5-dev qtlocation5-dev qtpositioning5-dev libqt5svg5-dev libqt5websockets5-dev qt5-default qbs qtwebengine5-dev gcovr lcov ccache cccc doxygen graphviz zip p7zip curl wget default-jre uuid-dev pkg-config qtcreator fuse python3-pip
    - ./scripts/build_grantlee.sh
    # build space creator
    - cd ${BUILD_DIR}
    - cmake -GNinja -S ${PROJECT_ROOT} -B ${BUILD_DIR} ${CMAKE_BUILD}
    - cmake --build . --target all
    - cd ${PROJECT_ROOT}
    # unit tests
    - cd ${DOWNLOAD_DIR}
    - wget -q -O - https://github.com/ttsiodras/asn1scc/releases/download/4.2.4.7f/asn1scc-bin-4.2.4.7f.tar.bz2 | tar jxvf -
    - export PATH=$PATH:${DOWNLOAD_DIR}/asn1scc
    - cd ${PROJECT_ROOT}
    - ./scripts/run_tests.sh ${BUILD_DIR}
    ## coverage
    #- export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:/usr/lib/x86_64-linux-gnu/qtcreator:/usr/lib/x86_64-linux-gnu/qtcreator/plugins
    #- export QT_QPA_PLATFORM=offscreen
    #- mkdir -p coverage ; cd coverage ; rm * -rf
    #- cmake -G Ninja -DCOVERAGE_ENABLED=ON ..
    #- ninja ; ../scripts/run_tests.sh . ; ninja coverage ; ninja coverage_html
    #- cd ..
    # documentation
    - ./scripts/generate_documentation.sh
    # debian package
    # install qtcreator sources
    - ./scripts/download_qtcreator.sh
    # build the plugin
    - cd ${BUILD_DIR}
    - cmake -GNinja -S ${PROJECT_ROOT} -B ${BUILD_DIR} ${CMAKE_BUILD} -DBUILD_PATCH_NUMBER=$CI_BUILD_ID -DENABLE_TESTS=OFF
    - cmake --build . --target all
    # Create .deb package
    - cpack
    - mkdir -p ${PACKAGE_DIR}
    - cp ${BUILD_DIR}/*.deb ${PACKAGE_DIR}
    # Create AppImage
    - ${PROJECT_ROOT}/scripts/create_appimage.sh
  cache:
    key: asn1scc
    paths:
      - build/asn1scc_bin
  artifacts:
    reports:
      junit: build/tst_*-result.xml
    paths:
      - doc/doxygen/html
      - package
    expire_in: 2 days
