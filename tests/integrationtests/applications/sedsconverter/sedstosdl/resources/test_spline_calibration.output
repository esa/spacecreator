process Calibration;
    dcl Iterator RealType;
    dcl Calibratedvalue RealType;
    dcl RawSplinePoints1 SplinePointsArray;
    dcl CalibratedSplinePoints1 SplinePointsArray;

    procedure FindInterval;
        dcl result SplinePointsArrayIndex;
        fpar
            in value SplinePointValue,
            in rawPoints SplinePointsArray;
        returns SplinePointsArrayIndex;
        START;
            task result := 0;
            find_interval_start:
            decision result < length(rawPoints);
                (True):
                    decision rawPoints(result) >= value;
                        (True):
                            return result;
                        (False):
                            task result := result + 1;
                            join find_interval_start;
                    enddecision;
                (False):
                    join find_interval_end;
            enddecision;
            find_interval_end:
            task result := result + 1;
        return result;
    endprocedure;

    procedure LinearCalibration;
        dcl intervalIndex SplinePointsArrayIndex;
        dcl x0 SplinePointValue;
        dcl x1 SplinePointValue;
        dcl y0 SplinePointValue;
        dcl y1 SplinePointValue;
        dcl l0 SplinePointValue;
        dcl l1 SplinePointValue;
        dcl result SplinePointValue;
        fpar
            in value SplinePointValue,
            in rawPoints SplinePointsArray,
            in calibratedPoints SplinePointsArray;
        returns SplinePointValue;
        START;
            task intervalIndex := call FindInterval(value, rawPoints);

            decision value = rawPoints(intervalIndex);
                (True):
                    return calibratedPoints(intervalIndex);
                (False):
            enddecision;

            task x0 := rawPoints(intervalIndex-1);
            task x1 := rawPoints(intervalIndex);
            task y0 := calibratedPoints(intervalIndex-1);
            task y1 := calibratedPoints(intervalIndex);
            task l0 := (value - x1) / (x0 - x1);
            task l1 := (value - x0) / (x1 - x0);

            task result := l0 * y0 + l1 * y1;
        return result;
    endprocedure;

    procedure SquareCalibration;
        dcl intervalIndex SplinePointsArrayIndex;
        dcl x0 SplinePointValue;
        dcl x1 SplinePointValue;
        dcl x2 SplinePointValue;
        dcl y0 SplinePointValue;
        dcl y1 SplinePointValue;
        dcl y2 SplinePointValue;
        dcl l0 SplinePointValue;
        dcl l1 SplinePointValue;
        dcl l2 SplinePointValue;
        dcl result SplinePointValue;
        fpar
            in value SplinePointValue,
            in rawPoints SplinePointsArray,
            in calibratedPoints SplinePointsArray;
        returns SplinePointValue;
        START;
            task intervalIndex := call FindInterval(value, rawPoints);

            task x0 := rawPoints(intervalIndex-1);
            task x1 := rawPoints(intervalIndex);
            task x2 := rawPoints(intervalIndex+1);
            task y0 := calibratedPoints(intervalIndex-1);
            task y1 := calibratedPoints(intervalIndex);
            task y2 := calibratedPoints(intervalIndex+1);
            task l0 := ((value - x1) * (value - x2)) / ((x0 - x1) * (x0 - x2));
            task l1 := ((value - x0) * (value - x2)) / ((x1 - x0) * (x1 - x2));
            task l2 := ((value - x0) * (value - x1)) / ((x2 - x0) * (x2 - x1));
            task result := l0 * y0 + l1 * y1 + l2 * y2;
        return result;
    endprocedure;

    procedure CubicCalibration;
        START;
        return ;
    endprocedure;

    procedure InitRawSplinePoints1;
        START;
            task RawSplinePoints1 := { -5.000000, 1.000000, 5.000000, 20.000000, 100.000000 };
        return ;
    endprocedure;

    procedure InitCalibratedSplinePoints1;
        START;
            task CalibratedSplinePoints1 := { -100.000000, 20.000000, 100.000000, 4000.000000, 20000.000000 };
        return ;
    endprocedure;

    procedure CalibrateActivity;
        START;
            task Iterator := 1.0;

            loop_start_1:
            decision Iterator <= 20.0;
                (False):
                    join loop_end_2;
                (True):
                    task Calibratedvalue := call LinearCalibration(Iterator, RawSplinePoints1, CalibratedSplinePoints1);
                    task Iterator := Iterator + 1.0;
                    join loop_start_1;
            enddecision;
            loop_end_2:
        return ;
    endprocedure;

    START;
        call InitRawSplinePoints1;
        call InitCalibratedSplinePoints1;
        NEXTSTATE Idle;

    state DoCalibration;
    endstate;

    state Idle;
        input ComponentInterface_Tick_Pi;
            call CalibrateActivity;
            NEXTSTATE DoCalibration;
    endstate;

endprocess Calibration;
